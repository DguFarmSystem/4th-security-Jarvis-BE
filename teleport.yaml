#
# A Sample Teleport configuration file.
#
# Things to update:
#  1. license.pem: Retrieve a license from your Teleport account https://teleport.sh
#     if you are an Enterprise customer.
#
version: v3
teleport:
  nodename: 26dc41c9ca07
  data_dir: /var/lib/teleport
  join_params:
    token_name: ""
    method: token
  log:
    output: stderr
    severity: INFO
    format:
      output: text
  ca_pin: ""
  diag_addr: ""
auth_service:
  enabled: "yes"
  listen_addr: 0.0.0.0:3025
  proxy_listener_mode: multiplex
  public_addr: "openswdev.duckdns.org:3080"
  cluster_name: "openswdev.duckdns.org"
  authentication:
    type: local
ssh_service:
  enabled: "no"
proxy_service:
  enabled: "yes"
  public_addr: openswdev.duckdns.org:3080
  https_keypairs:
    - cert_file: /etc/letsencrypt/live/openswdev.duckdns.org/fullchain.pem
      key_file: /etc/letsencrypt/live/openswdev.duckdns.org/privkey.pem

  https_keypairs_reload_interval: 0s
  acme: {}
app_service:
  enabled: true
  apps:
    - name: grafana
      uri: "http://grafana:3333"
      labels:
        env: "test"
    - name: "my-backend-api"
      # 1. 외부에서 접속할 공개 주소를 추가합니다.
      public_addr: "openswdev-api.duckdns.org"
      # 2. 내부 uri는 Go 앱이 실행되는 주소로 지정합니다.
      #    Teleport와 Go 앱이 같은 서버에 있으므로 localhost 사용이 가능합니다.
      uri: "http://172.17.0.1:8080"
            # [핵심] 헤더 주입(꼬리표 붙이기) 규칙입니다.
      rewrite:
        headers:
          # 각 항목을 "Key: Value" 형태의 단일 문자열로 수정합니다.
          - "Teleport-Username: {{internal.logins}}"
          - "Teleport-Roles: {{user.spec.roles}}"
          - "test: Hello world"
            # 공식 문서 기반의 완전한 CORS 설정
      cors:
        # [필수] Teleport 웹 UI의 주소를 허용된 출처로 지정합니다.
        allowed_origins:
          - "https://openswdev.duckdns.org:3080"

        # [권장] 향후 확장을 위해 일반적인 HTTP 메서드를 모두 허용합니다.
        allowed_methods:
          - "GET"
          - "POST"

        # [권장] 일반적인 요청 헤더를 허용합니다.
        allowed_headers:
          - "Content-Type"
          - "Accept"
          # 만약 프론트에서 Authorization 헤더를 직접 보낼 일이 있다면 추가합니다.
          # - "Authorization"

        # [필수] 브라우저가 Teleport 로그인 세션 쿠키를 요청에 포함하도록 허용합니다.
        allow_credentials: true

        # [권장] Preflight 요청 결과를 1시간 동안 캐시하여 성능을 향상시킵니다.
        max_age: 3600
db_service:
  enabled: "yes"
  databases:
  - name: "example-mysql"
    protocol: "mysql"
    uri: "test-database:3306"
